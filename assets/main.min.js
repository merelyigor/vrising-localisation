(()=>{"use strict";!function(){let e={},t=[];const n=40,o=document.getElementById("downloadLink"),r=document.querySelector(".download-json-server-wrap"),c=document.querySelector(".download-json-server"),l=localStorage.getItem("mainLocalizationArr");if(l&&l.length>100){o.style.display="flex";const e=localStorage.getItem("saveTime");e&&(document.getElementById("save-info-text").style.display="flex",s(e))}function s(e){const t=document.getElementById("saveTime");document.getElementById("save-info-text").style.display="flex",t&&(t.textContent=`Файл вже було згенеровано вами раніше, та збережено: ${new Date(e).toLocaleString()}`)}function i(e){const t=document.querySelector(".text-processing");t&&(t.innerHTML=e)}function a(e,t){const n=document.getElementById("progressBar"),o=document.getElementById("progressText"),r=Math.round(e/t*100);o.style.display="flex",n&&(n.style.width=`${r}%`),o&&(o.textContent=`${r}%`)}async function d(e,t={},n=300,o=1e3){let r=document.querySelector(".text-processing");for(let c=0;c<n;c++)try{const n=await fetch(e,t);if(!n.ok)throw new Error("Fetch error");return n}catch(e){if(console.error(`Fetch error on attempt ${c+1}: ${e.message}`),!(c<n-1))throw console.error("Error: Сервер не може надати відповідь!"),console.error("Error: Перевищено максимальну кількість спроб на відповіді від серверу!"),i(`Сервер повернув занадто багато помилкових відповідей \n                    а саме більше ніж ${n}.\n                    <br> Перевищено максимальну кількість спроб на відповіді від серверу!\n                    <br> Спробуйте перезавантажити сторінку та повторити генерацію заново.\n                    <span class="error">!!!</span>`),r.style.color="#ff0000",r.style.border="5px solid #ff0000",r.classList.add("shake-element"),e;await new Promise((e=>setTimeout(e,o)))}}function u(){!function(){const e=document.querySelector(".spinner"),t=document.querySelector(".container-spinner"),n=document.querySelector(".container-spinner-text");e&&(e.style.display="flex",t.style.display="flex",n.style.display="flex")}(),a(0,10),document.getElementById("downloadLink").style.display="none",document.getElementById("save-info-text").style.display="none",d("/?start-generation=1").then((e=>e.json())).then((l=>{let d=0;const u=l.length;let h=0;!function g(){if(d<l.length){let t=l[d];f(t.id,t.name).then((n=>{e[t.name]=n,d++,h++,a(h,u),g()})).catch((e=>{console.error("Error fetching strings:",e)}))}else(async function(e,t){const o=[],r=Object.values(e).reduce(((e,t)=>e+t.length),0);let c=0;for(let l in e)if(e.hasOwnProperty(l)&&l.endsWith(".csv")){let s=e[l];i(`Обробляємо та зберігаємо усі ID строк для файлу ${l}`);for(let e of s)o.push(m(l,e.fileId,e.stringId,e.stringIdentifier,t).then((()=>{c++,a(c,r)}))),o.length>=n&&(await Promise.all(o),o.length=0)}o.length>0&&await Promise.all(o);!function(){const e=document.querySelector(".spinner"),t=document.querySelector(".container-spinner");e&&(e.style.display="none",t.style.display="none")}()})(e,t).then((()=>{!function(e){a(100,100);const t={codes:[],nodes:e},n=JSON.stringify(t,null,2);localStorage.setItem("mainLocalizationArr",n);const l=(new Date).toISOString();localStorage.setItem("saveTime",l);const i=new Blob([n],{type:"application/json"}),d=URL.createObjectURL(i),u=document.createElement("a");if(u.href=d,u.download="Ukraine.json",document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(d),function(e){const t=new FormData;t.append("file",e,"Ukraine.json"),fetch("/save-json.php",{method:"POST",body:t}).then((e=>e.json())).then((e=>{console.log("File successfully uploaded:",e)})).catch((e=>{console.error("Error uploading file:",e)}))}(i),y(r,l),o){let e=localStorage.getItem("saveTime");e&&(document.getElementById("save-info-text").style.display="flex",s(e)),o.style.display="inline",c.style.display="block"}}(t)})).catch((e=>{console.error("Error processing all file strings:",e)}))}()})).catch((e=>{console.error("Error fetching files:",e)}))}function f(e,t,n=0,o=[]){return i(`Запитую усі ID рядків для файлу ${t}`),new Promise(((r,c)=>{d(`/?getAllStrings=all&fileId=${e}&offset=${n}`).then((e=>e.json())).then((l=>{500===l.length?(n+=l.length,o=o.concat(l),f(e,t,n,o).then(r).catch(c)):(o=o.concat(l),r(o))})).catch((e=>{console.error("Error fetching strings:",e),c(e)}))}))}function m(e,t,n,o,r){return new Promise(((c,l)=>{d(`/?translate=uk&fileId=${t}&stringId=${n}&stringIdentifier=${o}`).then((e=>e.json())).then((t=>{r.push({guid:t.stringIdentifier,text:t.text}),i(`Обробка перекладу для рядка ${t.stringIdentifier} <br>\n                                                  у файлі ${e} <br>\n                                                  фраза: ${t.text}`),c()})).catch((e=>{console.error("Error fetching translation:",e),l(e)}))}))}function y(e,t=!1){t?e.querySelector(".txt-time").textContent=`Створено: ${new Date(t).toLocaleString()}`:fetch("/check-file.php").then((e=>e.json())).then((t=>{"success"===t.status&&(e.style.display="block",e.querySelector(".txt-time").textContent=`Створено: ${t.fileTime}`)})).catch((e=>{console.error("Error:",e)}))}document.getElementById("toggleButton").addEventListener("click",(function(){const e=document.getElementById("textBlock"),t=this;e.classList.contains("expanded")?(e.classList.remove("expanded"),t.textContent="Показати все"):(e.classList.add("expanded"),t.textContent="Показати менше")})),function(e,t){y(t),e.addEventListener("click",(function(){fetch("/check-file.php").then((e=>e.json())).then((e=>{if("success"===e.status){const e=document.createElement("a");e.href="/json-local/Ukraine.json",e.download="Ukraine.json",document.body.appendChild(e),e.click(),document.body.removeChild(e)}else alert("Файл не знайдено на сервері.")})).catch((e=>{console.error("Error:",e)}))}))}(c,r),o&&o.addEventListener("click",(function(e){e.preventDefault(),function(){let e=localStorage.getItem("mainLocalizationArr");if(e){const t=JSON.parse(e),n=JSON.stringify(t,null,2),o=new Blob([n],{type:"application/json"}),r=window.URL.createObjectURL(o),c=document.createElement("a");c.href=r,c.download="Ukraine.json",document.body.appendChild(c),c.click(),document.body.removeChild(c),setTimeout((()=>{window.URL.revokeObjectURL(r)}),1e3)}}()})),document.getElementById("generateBtn").addEventListener("click",(function(){u()}))}()})();